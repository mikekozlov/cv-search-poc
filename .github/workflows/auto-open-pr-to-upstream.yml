name: Auto PR to upstream when ahead

on:
  push:
    branches:
      - main              # change or add patterns if you want more branches
  workflow_dispatch:       # optional manual run

jobs:
  pr-to-upstream:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create/Update PR to upstream if this branch is ahead
        env:
          # Your secret PAT; required to create a PR in the upstream repo
          GH_TOKEN: ${{ secrets.UPSTREAM_PR_TOKEN }}
          UPSTREAM_REPO: mikekozlov/cv-search-poc   # <— change if different
          BASE_BRANCH:   main                        # upstream base branch
          HEAD_OWNER:    ${{ github.repository_owner }}
          HEAD_BRANCH:   ${{ github.ref_name }}
        run: |
          set -euo pipefail

          echo "Checking if ${HEAD_OWNER}:${HEAD_BRANCH} is ahead of ${UPSTREAM_REPO}:${BASE_BRANCH}"

          # Use compare API across forks to see if we're ahead (no auth needed for public repos):
          cmp=$(curl -sSL -H "Accept: application/vnd.github+json" \
                "https://api.github.com/repos/${UPSTREAM_REPO}/compare/${BASE_BRANCH}...${HEAD_OWNER}:${HEAD_BRANCH}")
          ahead=$(echo "$cmp" | jq -r '.ahead_by // 0')

          if [ "${ahead}" -le 0 ]; then
            echo "Not ahead (ahead_by=${ahead}). Nothing to PR."
            exit 0
          fi

          # If a PR from this fork branch to upstream already exists and is open, do nothing.
          existing=$(gh pr list -R "${UPSTREAM_REPO}" \
                       --head "${HEAD_OWNER}:${HEAD_BRANCH}" \
                       --base "${BASE_BRANCH}" \
                       --state open \
                       --json number --jq '.[0].number')

          if [ -n "${existing}" ] && [ "${existing}" != "null" ]; then
            echo "PR #${existing} already open; pushing more commits will update it automatically."
            exit 0
          fi

          title="Auto PR: ${HEAD_OWNER}:${HEAD_BRANCH} → ${UPSTREAM_REPO}:${BASE_BRANCH}"
          body="This PR was created automatically because ${HEAD_OWNER}:${HEAD_BRANCH} is ahead of ${UPSTREAM_REPO}:${BASE_BRANCH}."

          # Create the PR in the upstream repository using GitHub CLI:
          gh pr create -R "${UPSTREAM_REPO}" \
            --base "${BASE_BRANCH}" \
            --head "${HEAD_OWNER}:${HEAD_BRANCH}" \
            --title "${title}" \
            --body "${body}"

          echo "Opened a new PR to ${UPSTREAM_REPO}."
